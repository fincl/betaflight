name: Build Betaflight (PICO2_2350A custom config)

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Target config name (must match a folder in src/config/configs)"
        required: true
        default: "PICO2_2350A"
      config_ref:
        description: "Branch, tag, or commit in fincl/config to fetch config.h from"
        required: true
        default: "master"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Betaflight firmware source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            make git gcc g++ python3 curl \
            cmake ninja-build pkg-config \
            bzip2 xz-utils unzip

      - name: Install ARM toolchain (Betaflight)
        run: |
          make arm_sdk_install

      - name: Hydrate Pico SDK
        run: |
          make pico_sdk

      - name: Install picotool
        run: |
          make picotool_install

      - name: Hydrate configs
        run: |
          make configs

      - name: Overlay custom config.h
        run: |
          curl -L \
            "https://raw.githubusercontent.com/fincl/config/${{ inputs.config_ref }}/configs/PICO2_2350A/config.h" \
            -o "src/config/configs/PICO2_2350A/config.h"

          echo "Confirmed custom config.h (first 80 lines):"
          sed -n '1,80p' src/config/configs/PICO2_2350A/config.h

      - name: Patch config.h to enable magnetometer
        shell: bash
        run: |
          set -euo pipefail
          CFG="src/config/configs/PICO2_2350A/config.h"

          echo "---- Patching $CFG to enable magnetometer (USE_MAG) ----"

          # Helper to add a define only if it's not already present (as define or commented define).
          add_define() {
            local define_line="$1"
            local macro_name
            macro_name="$(echo "$define_line" | awk '{print $2}')"
            if grep -Eq "^[[:space:]]*#define[[:space:]]+$macro_name([[:space:]]+|$)" "$CFG"; then
              echo "Already present: $macro_name"
            else
              echo "$define_line" >> "$CFG"
              echo "Added: $define_line"
            fi
          }

          echo "" >> "$CFG"
          echo "// ---- Added by GitHub Actions to enable magnetometer support ----" >> "$CFG"

          # Core magnetometer feature gate
          add_define "#define USE_MAG"

          # Enable common I2C mag drivers so 'mag_hardware' options exist in CLI.
          # (Pick the one you actually have in the CLI later, e.g. QMC5883 / HMC5883 / LIS3MDL, etc.)
          add_define "#define USE_MAG_QMC5883"
          add_define "#define USE_MAG_HMC5883"
          add_define "#define USE_MAG_LIS3MDL"
          add_define "#define USE_MAG_LIS2MDL"
          add_define "#define USE_MAG_AK8963"

          echo ""
          echo "---- Final magnetometer-related lines in config.h ----"
          grep -nE "^[[:space:]]*#define[[:space:]]+USE_MAG($|[[:space:]])|^[[:space:]]*#define[[:space:]]+USE_MAG_" "$CFG" || true

      - name: Build firmware
        shell: bash
        run: |
          set -o pipefail
          make "${{ inputs.target }}" V=1 2>&1 | tee build.log

      - name: Verify magnetometer was compiled in
        shell: bash
        run: |
          set -euo pipefail

          echo "Verifying magnetometer support was compiled (looking for compass/mag sources in build.log)..."

          # This is intentionally NOT checking for -DUSE_MAG (your build system doesn't propagate *_EXTRA into gcc flags).
          # Instead, we check for compilation of compass/mag related C files.
          if grep -Eiq "(sensors/compass\.c|drivers/compass/|compass_|mag_)" build.log; then
            echo "OK: compass/mag code appears in the build output."
          else
            echo "ERROR: did not see compass/mag sources compiled in build.log."
            echo "If you still get 'MAG: Not included in build', the target may be excluding mag at a deeper level."
            echo "===== HINTS ====="
            echo "1) Confirm the patched config.h is actually used by the build."
            echo "2) Search build.log for which config.h path is being included (look for -I./src/config/configs/PICO2_2350A)."
            exit 1
          fi

      - name: Show build failure tail
        if: failure()
        run: |
          echo "===== LAST 200 LINES OF build.log ====="
          tail -n 200 build.log

      - name: List build outputs
        if: always()
        run: |
          echo "==== firmware outputs under obj/ ===="
          find obj -type f \( -name "*.uf2" -o -name "*.elf" -o -name "*.bin" -o -name "*.hex" \) -print | sort || true

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: betaflight-${{ inputs.target }}-firmware
          path: |
            build.log
            obj/**/*.uf2
            obj/**/*.elf
            obj/**/*.bin
            obj/**/*.hex
          if-no-files-found: error
