name: Build Betaflight (PICO2_2350A custom config)

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Target config name (must match a folder in src/config/configs)"
        required: true
        default: "PICO2_2350A"
      config_ref:
        description: "Branch, tag, or commit in fincl/config to fetch config.h from"
        required: true
        default: "master"
      extra_flags:
        description: "Extra preprocessor flags passed via EXTRA_FLAGS (Cloud Build style)"
        required: false
        default: >-
          -DUSE_MAG
          -DUSE_GPS
          -DUSE_SERIALRX
          -DUSE_SERIALRX_MAVLINK
          -DUSE_TELEMETRY
          -DUSE_TELEMETRY_MAVLINK

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Betaflight firmware source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            make git gcc g++ python3 curl \
            cmake ninja-build pkg-config \
            bzip2 xz-utils unzip

      - name: Install ARM toolchain (Betaflight)
        run: |
          make arm_sdk_install

      - name: Hydrate Pico SDK
        run: |
          make pico_sdk

      - name: Install picotool
        run: |
          make picotool_install

      - name: Hydrate configs
        run: |
          make configs

      - name: Overlay custom config.h
        run: |
          curl -L \
            "https://raw.githubusercontent.com/fincl/config/${{ inputs.config_ref }}/configs/PICO2_2350A/config.h" \
            -o "src/config/configs/PICO2_2350A/config.h"

          echo "Confirmed custom config.h (first 120 lines):"
          sed -n '1,120p' src/config/configs/PICO2_2350A/config.h

      - name: Build firmware (Cloud Build style EXTRA_FLAGS)
        shell: bash
        run: |
          set -euo pipefail
          set -o pipefail

          # Flatten possible newlines in input into spaces (EXTRA_FLAGS expects a single string)
          EXTRA_FLAGS_FLAT="$(printf '%s' "${{ inputs.extra_flags }}" | tr '\n' ' ')"

          echo "Using EXTRA_FLAGS: ${EXTRA_FLAGS_FLAT}"

          make "${{ inputs.target }}" EXTRA_FLAGS="${EXTRA_FLAGS_FLAT}" V=1 2>&1 | tee build.log

          echo
          echo "Verifying that USE_MAG was applied in compile commands..."
          if grep -q -- "-DUSE_MAG" build.log; then
            echo "OK: -DUSE_MAG present in build.log"
          else
            echo "ERROR: -DUSE_MAG not found in build.log. Magnetometer may not be recorded as a build option."
            exit 1
          fi

          echo
          echo "Verifying that USE_GPS was applied in compile commands..."
          if grep -q -- "-DUSE_GPS" build.log; then
            echo "OK: -DUSE_GPS present in build.log"
          else
            echo "WARNING: -DUSE_GPS not found in build.log."
          fi

      - name: Show build failure tail
        if: failure()
        run: |
          echo "===== LAST 200 LINES OF build.log ====="
          tail -n 200 build.log

      - name: List build outputs
        if: always()
        run: |
          echo "==== firmware outputs under obj/ ===="
          find obj -type f \( -name "*.uf2" -o -name "*.elf" -o -name "*.bin" -o -name "*.hex" \) -print | sort || true

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: betaflight-${{ inputs.target }}-firmware
          path: |
            build.log
            obj/**/*.uf2
            obj/**/*.elf
            obj/**/*.bin
            obj/**/*.hex
          if-no-files-found: error
